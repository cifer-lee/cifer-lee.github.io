---
layout: post
title: "阿里云SLB配置日志"
date: 2013-07-30 19:45
---

使用阿里云的负载均衡服务必须要有两台以上的云主机，而且我们只能在同一节点上的几个云主机之间进行负载均衡。还有一个限制就是，作为负载均衡用的主机不能再当作客户端用。

按照阿里云提供的手册一步一步配置下来不难，但其中有几个地方值得记录一下。

1. 前端端口与后端端口

前段端口是均衡服务器的端口，后端端口是实际运行服务的服务器的端口。

2. 健康状态检查

阿里云SLB还提供一个健康状态检查服务，这个服务能按照你的设定检查服务器集群中每台服务器的健康状态，发现有down掉的服务器后会将其从集群中剔除，若这台服务器恢复正常运行的话还能将其加回到集群中。

这里重点说一下SLB健康状态检查的机制，以下的分析都是来源于tcpdump的抓包。

阿里云是在内网中选两台机器跟你的集群中的服务器建立TCP连接，一旦建立成功，就立马断开连接，断开的方式是发送RST包。根据你的设定，这两台服务器可能会重复上述动作n次，然后将连接成功的次数与你设定的阈值相比较来判定你这态服务器是不是处于健康状态。

这里我遇到的问题是，不使用这个SLB服务的时候，我的mqtt server运行的很正常，但是使用了SLB服务后，我的mqtt server运行日志里每2秒就会输出一条“Error：ECONNREST”错误，这令我摸不着头脑。于是便有了上面那一段。

nodejs的网络层实现就是这样的：收到RST报文后就回触发error事件，我的mqtt server程序中侦听了这个事件，于是这个错误就回馈到我的程序中了。其他的程序库中对待RST报文的方式可能也会有和nodejs相似者，到时若碰到这情况，也就见怪不怪了。


最后，我还有一个不懂的地方，就是手册中频频出现的"VIP"是什么意思？好像是负责分流的那台服务器的地址？
